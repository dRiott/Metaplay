package com.thoughtriott.metaplay.controllers;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.SessionAttributes;
import org.springframework.web.bind.support.SessionStatus;

import com.thoughtriott.metaplay.data.entities.Artist;
import com.thoughtriott.metaplay.data.entities.Genre;
import com.thoughtriott.metaplay.data.entities.Location;
import com.thoughtriott.metaplay.data.entities.RecordLabel;
import com.thoughtriott.metaplay.data.services.ArtistService;
import com.thoughtriott.metaplay.data.services.GenreService;
import com.thoughtriott.metaplay.data.services.LocationService;
import com.thoughtriott.metaplay.data.services.RecordLabelService;
import com.thoughtriott.metaplay.data.wrappers.CreateArtistWrapper;

@Controller
@RequestMapping("/artist")
@SessionAttributes("artist")
public class ArtistController {

	@PersistenceContext
	private EntityManager em;
	
	@Autowired
	private ArtistService artistService;
	@Autowired
	private LocationService locationService;
	@Autowired
	private GenreService genreService;
	@Autowired
	private RecordLabelService recordLabelService;

	
	@RequestMapping("/add")
	public String addArtist() {
		System.out.println("Adding a new Artist to the model with the @ModelAttribute annotation.");
		return "artist_add";
	}
	
	@RequestMapping("/review")
	public String review(HttpSession session, @ModelAttribute CreateArtistWrapper createArtistWrapper) {
		System.out.println("Invoking review() in ArtistController");
		session.setAttribute("createArtistWrapper", createArtistWrapper);
		return "artist_review";
	}
	
	@RequestMapping("/save")
	public String saveArtist(@ModelAttribute CreateArtistWrapper createArtistWrapper, SessionStatus status, HttpSession session) {
		System.out.println("Invoking the saveArtist() from ArtistController.");

		CreateArtistWrapper caw = (CreateArtistWrapper) session.getAttribute("createArtistWrapper");
		if(caw == null) {
			System.out.println("CreateArtistWrapper is null for some reason.");
		}
		
		Artist futureArtist = new Artist();
		
		
// 		Setting/Creating a Location
		String city = (String) session.getAttribute("locationCity");
		String state = (String) session.getAttribute("locationState");
		if(locationService.findLocation(city, state)!=null) {
			Location l = locationService.findLocation(city, state);
			futureArtist.setLocation(l);
		} else {
			Location l = locationService.createLocation(city, state);
			futureArtist.setLocation(l);
		}
		
// 		Setting/Creating a Record Label
		String recordLabelName = (String) session.getAttribute("recordLabelName");
		if(recordLabelService.findRecordLabelByName(recordLabelName)!=null) {
			RecordLabel rl = (RecordLabel) recordLabelService.findRecordLabelByName(recordLabelName);
			futureArtist.setRecordLabel(rl);
		} else {
			RecordLabel rl = (RecordLabel) recordLabelService.createRecordLabel(recordLabelName, locationService.findLocation(city, state));
		}

		
//		Genre g = (Genre) session.getAttribute("genre");
//		System.out.println(g);
//
//		RecordLabel rl = (RecordLabel) session.getAttribute("recordLabel");
//		System.out.println(rl);
//
//		int locationId = l.getId();
//		int recordLabelId = rl.getId();
//		int genreId = g.getId();
		
//		artistService.createArtist(a.getName(), genreId, locationId, recordLabelId, a.getBiography());
//		artistService.createArtist(a.getName(), a.getBiography());
		
		//setComplete wipes the session of the info that we passed to the review page
		//so that when we redirect to the /artist/add page, a blank form is displayed.
		status.setComplete();
		return "redirect:/artist/add";
	}
	
	@RequestMapping("/find")
	public String findArtist() {
		//implement findArtist method
		// return "artists"
		return "404";
	}
	
	// Adds the Artist to the Model with the @ModelAttribute annotation
	@ModelAttribute("artist")
	public Artist getArtist() {
		return new Artist();
	}
	
	// Adds the Location to the Model with the @ModelAttribute annotation
	@ModelAttribute("location")
	public Location getLocation() {
		return new Location();
	}
	
	// Adds the Location to the Model with the @ModelAttribute annotation
	@ModelAttribute("genre")
	public Genre getGenre() {
		return new Genre();
	}
	
	// Adds the Location to the Model with the @ModelAttribute annotation
	@ModelAttribute("recordLabel")
	public RecordLabel getRecordLabel() {
		return new RecordLabel();
	}
	
	@ModelAttribute("createArtistWrapper")
	public CreateArtistWrapper getCreateArtistWrapper() {
		return new CreateArtistWrapper();
	}
	
	//@ModelAttribute annotation tells spring that this method 
	// should have its return value placed within the model with key "locationOptions"
	@ModelAttribute(value="locationOptions")
	public List<String> getLocations() {
		return new LinkedList<>(Arrays.asList(new String[] { "Seattle", "Los Angeles", "Denver",
				"San Francisco", "Chicago", "Atlanta", "Dallas", "Portland", "Other" }));
	}
	
	// place "genreOptions" List in the model to be used on our artist_add.jsp page
	@ModelAttribute(value="genreOptions")
	public List<String> getGenres() {
		return  new LinkedList<>(Arrays.asList(new String[] { "Blues", "Rock", "Juke",
				"D&B", "Jazz Hop", "Hip Hop", "BasedGod", "Drugs", "Other" }));
	}
}
